@page "/servicios"
@attribute [Authorize(Roles = "Doctora")]
@inject IHttpContextAccessor _httpContextAccessor
@inject IEmployeeServices _employeeServices
@inject DialogService _dialogService

<div class="row">
    <div class="col-xl-4 order-xl-2 mb-3">
        <div class="card card-body" style="min-height:190px;">
            <p class="lead">Seleccione un servicio</p>
            <RadzenDropDown Placeholder="Servicio" AllowClear="false" TValue="int" TextProperty="ServiceName"
                            ValueProperty="ServiceId" Data=@servicesOffered @bind-Value=@selectedServiceId
                            Disabled=@(currentService.ServiceId == 0) Change=@OnServiceChange />
            <div class="mt-4">
                <button @onclick="CreateService" class="btn btn-outline-info btn-sm" type="button">Crear un servicio</button>
                <button @onclick="CreateSchedule" disabled="@(currentService.ServiceId == 0)" class="btn btn-outline-secondary btn-sm" type="button">Crear horario</button>
            </div>
        </div>
    </div>
    <div class="col-xl-8 order-xl-1 mb-3">
        @if (currentService.ServiceId == 0)
        {
            <p class="lead mt-3">Aún no ha creado ningún servicio. Luego de crear uno, lograrás verlo aquí.</p>
        }
        else
        {
            <div class="card card-body">
                <div class="row">
                    <div class="col-lg-7">
                        <b>Servicio</b>
                        <h3 class="fw-400">@currentService.ServiceName</h3>
                        <b>Descripción</b>
                        <div style="height:70px;overflow-y:auto;">
                            <p class="fw-400">@currentService.ServiceDescription</p>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <b>Estado</b>
                        <h3>
                            <span class="text-white badge @(currentService.IsActive ? "bg-success" : "bg-secondary")">@(currentService.IsActive ? "Activo" : "Pausado")</span>
                        </h3>
                        <b>Duración estimada</b>
                        <h3 class="fw-400">@currentService.EstimatedDurationInMinutes minutos</h3>
                    </div>
                    <div class="col-xl-2 mt-4">
                        <button @onclick="() => EditService(currentService.ServiceId)" class="btn btn-outline-info btn-sm" type="button">Editar</button>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="col-12 order-3 mt-1">
        @if (currentService.ServiceId != 0)
        {
            <RadzenScheduler style="height:920px;" @ref=@scheduler LoadData="@OnLoadData" TItem="ServiceSchedule"
                         Data=@currentServiceSchedules StartProperty="Start" EndProperty="End" TextProperty="ScheduleDisplayText" SelectedIndex="2"
                         SlotSelect=@OnSlotSelect AppointmentSelect=@OnAppointmentSelect AppointmentRender=@OnAppointmentRender>
                <RadzenDayView />
                <RadzenWeekView />
                <RadzenMonthView />
            </RadzenScheduler>
        }
    </div>
</div>

@code {
    private string userId;
    private int selectedServiceId;
    private EmployeeService currentService = new EmployeeService();
    private List<EmployeeService> servicesOffered = new List<EmployeeService>();

    private RadzenScheduler<ServiceSchedule> scheduler;
    private List<ServiceSchedule> currentServiceSchedules = new List<ServiceSchedule>();

    protected override async Task OnParametersSetAsync()
    {
        userId = _httpContextAccessor.HttpContext.User.GetUserId();
        servicesOffered = await _employeeServices.GetServicesOffered(userId);

        if (servicesOffered.Count > 0)
        {
            currentService = servicesOffered.First();
            selectedServiceId = currentService.ServiceId;
        }
    }

    private async Task EditService(int serviceId)
    {
        // Display modal to edit or delete the service
    }

    private async Task OnServiceChange()
    {
        currentService = servicesOffered.Where(x => x.ServiceId == selectedServiceId).First();
        await scheduler.Reload();
    }

    private async Task CreateService()
    {
        await _dialogService.OpenAsync<CreateServicePage>("Crear un servicio nuevo", new Dictionary<string, object> { { "UserId", userId } });
        servicesOffered = await _employeeServices.GetServicesOffered(userId);
    }

    private async Task CreateSchedule()
    {
        await _dialogService.OpenAsync<AddServiceSchedulePage>("Crear un horario nuevo",
        new Dictionary<string, object> { { "ServiceId", selectedServiceId }, { "ServiceName", currentService.ServiceName } });
        await scheduler.Reload();
    }

    private async Task OnLoadData(SchedulerLoadDataEventArgs args)
    {
        currentServiceSchedules = await _employeeServices.GetServiceSchedulesBetweenDates(selectedServiceId, args.Start, args.End, userId);
    }

    private async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        await _dialogService.OpenAsync<AddServiceSchedulePage>("Crear un horario nuevo",
        new Dictionary<string, object> { { "ServiceId", selectedServiceId }, { "ServiceName", currentService.ServiceName }, { "ScheduleDate", args.Start } });
        await scheduler.Reload();
    }

    private async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<ServiceSchedule> args)
    {
        // TODO: Display modal to edit or delete the selected schedule
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<ServiceSchedule> args)
    {
        var currentTime = DateTime.UtcNow.ToLocalTime();
        if (args.Data.End < currentTime)
        {
            args.Attributes["style"] = "background: #B0C4DE";
        }
        else
        {
            args.Attributes["style"] = "background: #17a2b8";
        }
    }
}
